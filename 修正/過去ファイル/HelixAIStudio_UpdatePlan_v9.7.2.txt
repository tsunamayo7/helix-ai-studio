# 目的
HelixAIStudio v9.7.2 のGitHub公開に向け、下記アップデートを実装してください。
最重要: Claude Code CLI 前提（API由来のUI/コードを整理）、他ユーザー環境でも破綻しない設定UIにする。

# 実行方針（コスト最適化）
- 可能なら「計画(Plan)=Opus / 実装(編集)=Sonnet」の運用に寄せる。
- mixAIのPhase3(判断)とPhase4(実装)を分離し、Phase4はSonnet 4.5/4.6の選択式にする。
- 2026.2.17に追加されたモデルsonnet 4.6（claude --model claude-sonnet-4-6）を新規追加し使用可能にする。
- 既存機能を壊さないため、設定はマイグレーション（旧キーも読める/自動移行）を入れる。

# 変更要件一覧（実装タスク）
## A. Claudeモデル追加と並び順統一（mixAI/soloAI 共通）
1) 既存のモデル選択肢に「Sonnet 4.6」を追加。
   - 追加位置: Opus 4.6 の直下
   - 並び順: Opus4.6 → Sonnet4.6 → Opus4.5 → Sonnet4.5 → その他
2) mixAIのPhase1/3モデルも上記順で並ぶよう統一。
3) 1Mコンテキスト表記（例: claude-opus-4-6[1m]）は“実験/制限付き”扱いにする。
   - UIに出す場合: 「API/従量課金でのみ利用できる可能性」等の注記を付け、既定OFFにする。
   - CLI実行でエラーが出たら通常モデルへフォールバックし、ログに理由を残す。

## B. 「思考モード」完全削除（mixAI/soloAI 共通）
1) 現在UIにある「思考モード」(ON/OFF/等) を mixAI設定画面 / soloAI設定画面 から削除。
2) 思考モードに紐づく設定キー、enum/定数、保存/読込、分岐コードを削除。
3) もしCLIコマンド生成で思考モード相当のフラグ/挙動が残っている場合は撤去。
4) 代替案（任意）:
   - 今後Opus 4.6の推論強度を調整したくなった場合のために、
     「effort(低/中/高)」など“CLI/設定で扱える形”を一般設定に追加できる余地だけ設計しておく（今回はUI追加しなくてもよい）。

## C. 「常駐モデル」設定を“他ユーザー対応”に修正（場所/機能/UI）
1) 「常駐モデル」はアプリ全体へ影響するため、mixAI設定から外して「一般設定」へ移設する。
   - 移設対象: 常駐モデルON/OFF、制御AI(画像解析/判定)モデル、Embeddingモデル、(必要なら)使用GPU/使用先
2) 5070 Ti など特定GPU名の固定表記を廃止し、検出したGPU情報から動的表示にする。
3) GPUが1つの場合:
   - 常駐モデルはPhase2ローカルLLMと同じ実行基盤（同GPU/同Ollamaインスタンス）で動く前提でOK。
4) GPUが2つ以上の場合:
   - 「常駐モデルの実行先」を選べるようにする（例: GPU0 / GPU1）。
   - 技術的にOllamaは“1インスタンス=使用GPU固定”になりがちなので、
     実行先の選択は「Ollama接続プロファイル(ポート違い等)」として実装してもよい。
5) UI改善:
   - 現状プルダウンが見えないため、各モデル行に「変更」または「▼」ボタンを付け、押下でプルダウン(showPopup)が開くようにする。
6) 16GB級GPUユーザーでも動く軽量候補をプルダウンに追加（例）
   - 制御AI/軽量: qwen3-vl:2b（※利用にはOllama側の要件があるので注記）/ あるいはテキスト専用の軽量モデル
   - Embedding/軽量: qwen3-embedding の0.6B系（タグが複数あるので実在タグに合わせる）
   - 既存候補は維持しつつ、軽量セットを追加する

## D. Phase2ローカルLLM設定の改善（容量表記/ボタン/軽量候補/スキップ）
1) 容量表記(75GB等)の固定表示をやめる。
   - 表示するなら「全候補の右に一律表示」または「選択中モデルに追従して更新」のどちらかに統一。
2) モデル変更のUIを明確化:
   - 各カテゴリ行に「変更」/「▼」ボタンを付け、プルダウンを確実に開けるようにする。
3) 16GB級GPU向けの候補を追加（例）
   - coding: cogito:14b など
   - research: ministral-3:14b など
   - reasoning: 既存のphi4-reasoning系(搭載済みなら維持)
   - translation: translategemma:12b / 4b
   - vision: qwen3-vl:8b / 2b
4) 重要: 各カテゴリに「未選択(空白/None)」を設定可能にする。
   - 未選択の場合、そのカテゴリ工程はスキップし、P1とP3のみで最終決定する。

## E. mixAI Phase1/3/4 の再編（Opus→Sonnetで実装分離）
1) Phase1/3: デフォルトを Opus 4.6 にする。
2) Phase3を「判断(比較統合)」に専念させ、ファイル変更や実装はPhase4へ移す。
3) Phase4: Sonnet 4.5 / Sonnet 4.6 の選択式にする（デフォルト Sonnet 4.6）
4) 実装案:
   - Phase3出力を構造化（例: JSONブロックで file_changes と final_answer を分離）
   - Phase4は file_changes を適用し、diff/簡易テスト結果を返す
   - Phase4が無効 or file_changesなし の場合はPhase4スキップ

## F. mixAIチャット「[コンテキストに追加]」表示バグ修正
1) 何も無いのに帯が表示される/機能不明な状態を解消する。
2) 対策:
   - 通知ウィジェットは初期非表示にし、実際に“追加可能なコンテキスト”が生成された時だけ表示。
   - 閉じる(x)で完全に非表示へ戻る。
   - 表示条件/用途が分かる説明（ツールチップ or 小さな説明文）を追加。

# 受け入れ条件（最低限）
- Sonnet 4.6が mixAI/soloAI のモデル選択に追加され、指定順で並ぶ。
- 思考モードUI/設定/関連コードが消えても動作し、CLIのみ運用で破綻しない。
- 常駐モデル設定が一般設定へ移り、特定GPU名固定がなくなり、他ユーザーでも設定可能。
- Phase2の各カテゴリが未選択にでき、未選択カテゴリはスキップされる。
- Phase3(判断)とPhase4(実装)が分離され、Phase4はSonnet 4.5/4.6から選べる。
- [コンテキストに追加]の帯が“必要時のみ”表示され、用途が明確。

# 仕上げ
- 設定ファイルの互換（旧キー読み込み→新キーへ自動移行）を入れる。
- UI表示崩れがないか確認。
- GitHub公開用に、README/設定説明（GPU1枚/2枚、Ollama複数プロファイルの考え方）を追記。
