\### Claude への正式指示文（HelixAIStudio vx.x.x / UI\&挙動の改善・改訂版）



\*\*事前確認\*\*



\* "C:\Users\tomot\Desktop\開発環境\生成AIアプリ\Helix AI Studio\BIBLE\_Helix AI Studio\_x.x.x.md" 最新版を読んで、現在のアプリ全体像を把握し、改善点を特定すること。
\* "C:\Users\tomot\Desktop\開発環境\生成AIアプリ\Helix AI Studio"内の各ファイルのうち対象となるファイルを作成・削除・修正すること。
\* "C:\Users\tomot\Desktop\開発環境\生成AIアプリ\Helix AI Studio"内の各ファイルのうち不要となっている機能やUIに関するコード・ファイルを確認した場合は適切に削除等の処理をして軽量化すること。
\* あなた自身がWebで関連情報をWeb検索して情報収集し、GitHub、公式ドキュメント（Anthropic / Claude Code / OpenAI CLI）等を参照してアップデートを検証・補強すること。



---



\## 修正内容等

添付の現状スクショ（mixAI設定・RAG設定）を見る限り、**「固定配列でaddItems」「setEditable(True)のまま」**が残っていて、**cloudAI/localAI側の“登録済み/インストール済みモデル一覧”を参照していない**のが主因です。以下を **ClaudeCode(Sonnet 4.6 CLI)** に渡して、そのまま実装・反映できる形の **指示書**にしました。

---

# ClaudeCode向け 指示書

## ゴール（今回の仕様）

### mixAI > 設定

* **Phase1/3**：cloudAIの「登録済みモデル（cloud_models.json）」を**全件表示**
* **Phase2（カテゴリ別：coding/research/…）**：

  * **cloudAI登録済みモデル 全件** ＋ **localAIインストール済みモデル（Ollama /api/tags）全件** を**全件表示**
* **Phase3.5 / Phase4**：cloudAI登録済みモデルを**全件表示**
* すべての選択UIは

  * **キーボードで編集不可（setEditable(False)）**
  * **どこをクリックしてもドロップダウンが開く（showPopup）**
    に統一する（Phase1/3と同じ挙動）

### RAG > 設定（使用モデル設定）

* 「cloudモデル」：cloudAI登録済みモデルを**全件表示**
* 「実行LLM」→ **「実行モデル」** に名称変更
* 「品質チェックLLM」→ **「品質チェックモデル」** に名称変更
* 「実行モデル」「品質チェックモデル」「Embeddingモデル」：**localAIインストール済みモデルを全件表示**
* 選択UIは mixAI と同様に

  * **編集不可**
  * **どこクリックでもドロップダウン表示**
    に統一

### 反映更新（重要）

* cloudAI/localAIタブでモデル変更（登録追加/削除・モデル一覧更新）したら、
  **mixAI/RAG側へ反映するための「更新/再読込」ボタン**を適切に配置する

  * 可能なら **イベント（signal）でも自動反映**する

---

# 実装方針（再発防止のための“中核”）

## 1) モデル一覧の“唯一の情報源”を作る（ModelCatalog）

「UIが固定」になる原因は、各タブが**それぞれ固定配列を持っている**ことです。
→ **cloud/local のモデル一覧取得は1箇所に集約**し、各タブはそれを呼ぶだけに統一する。

### 1-A) CloudModelCatalog（cloud_models.json）

* 取得元：`config/cloud_models.json`
* 返す値：`[{name, model_id, command, builtin}, ...]`
* cloud_models.json は v11仕様にある形式を正とする（既存のcloudAIが使っている想定）

### 1-B) LocalModelCatalog（Ollama /api/tags）

* 取得元：Ollama `GET /api/tags`
* 返す値：`["model:tag", ...]`（nameだけでOK）
* /api/tags は Ollama公式で「ローカルにあるモデル一覧」を返す仕様（例付き）です。 ([Ollama Documentation][1])

---

## 2) ComboBox挙動を“共通部品”で強制統一

### 要件

* 編集不可：`setEditable(False)`
* どこクリックでも開く：`showPopup()`
  `QComboBox`は編集可否を `setEditable()` で制御でき、ドロップダウン表示は `showPopup()` で明示できます。 ([doc.qt.io][2])

### 実装（例：NoScrollComboBoxを拡張して統一）

```python
class NoScrollComboBox(QComboBox):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.setEditable(False)  # 編集不可をデフォルトに
        self.setFocusPolicy(Qt.FocusPolicy.StrongFocus)

    def wheelEvent(self, e):
        e.ignore()  # 既存仕様（ホイール誤変更防止）

    def mousePressEvent(self, e):
        # どこクリックでも開く
        if e.button() == Qt.MouseButton.LeftButton:
            self.showPopup()
            return
        super().mousePressEvent(e)
```

* `showPopup()` は「コンボのリストを表示する」公式API。 ([doc.qt.io][3])

---

# 具体タスク（ファイル/関数単位）

## A) mixAI（src/tabs/helix_orchestrator_tab.py）

### A-1) Phase1/3（P1/P3モデル：engine_combo）

現状 `_engine_options` が固定＆ `_add_ollama_engines()` などが混ざっている。
→ **cloud_models.json をロードして engine_combo を再生成**する。

**やること**

1. `engine_combo.clear()`
2. `cloud_models = CloudModelCatalog.load()`
3. `for m in cloud_models: engine_combo.addItem(m["name"], m["model_id"])`
4. 保存値（model_id）で復元

**注意**

* ここは “cloudAI登録済みモデル” を全件表示が要件。
* GPT-5.3 Codex も cloud_models.json に入っている想定なので、固定配列は撤廃。

---

### A-2) Phase2（カテゴリ別モデル：coding/research/reasoning/translation/vision）

現状 `setEditable(True)` + 固定 `addItems([devstral..., ...])` が残存している。
→ **全カテゴリで**候補を次で統一する：

* 候補リスト：
  `["(未選択 - スキップ)"] + cloud_models(all names) + local_models(all installed)`
* UI：**編集不可**、クリックで即open
* “▼変更ボタン”は不要（どこクリックでも開くため）。残すならOKだが冗長。

**やること**

1. `local_models = LocalModelCatalog.fetch(ollama_url)`（/api/tags） ([Ollama Documentation][1])
2. `cloud_names = [m["name"] for m in cloud_models]`
3. `choices = [t('desktop.mixAI.unselected')] + cloud_names + local_models`
4. 各カテゴリcomboを `clear()` → `addItems(choices)` → 保存値で復元

---

### A-3) Phase3.5 / Phase4（モデル候補）

現状 Phase4は `["disabled", "Sonnet4.6", "Sonnet4.5"]` など固定。
→ **cloudAI登録済みモデルを全件表示**へ変更。

**候補**

* Phase3.5：`["なし(スキップ)"] + cloud_models(all names)`
* Phase4：`["なし(スキップ)"] + cloud_models(all names)`
  （※あなたの運用方針で Phase4=レビュー専用など制限したいなら別途フィルタを入れる。ただし今回は「全件表示」が要件）

---

### A-4) 「更新」ボタン（反映が間に合わない問題の実用対策）

mixAI設定内に以下を追加（配置は Phase2ブロック右上が分かりやすい）：

* `🔄 モデル更新`

  * 押下で `CloudModelCatalog.reload()`（json読み直し）
  * `LocalModelCatalog.fetch()`（/api/tags取り直し）
  * その後、Phase1/2/3.5/4の全コンボを再構築

---

## B) RAG設定（RAGタブ設定UI：該当クラス/ファイルを検索して特定）

※プロジェクトによって `InformationCollectionTab` か `RAGTab` に実装が分散している可能性があるため、まず `ripgrep` で特定：

* `desktop.infoTab.execLLMLabel`
* `RAG構築設定` / `使用モデル設定`
* `model_info` / `execLLM` / `quality` / `embedding`

### B-1) UI仕様（あなたの要件通り）

* cloudモデル（名称はそのままでOK） → **cloud_models.json 全件を combo で表示**
* 実行LLM → ラベルを **実行モデル**
* 品質チェックLLM → ラベルを **品質チェックモデル**
* 実行モデル / 品質チェックモデル / Embeddingモデル → **Ollamaインストール済み全件**（/api/tags） ([Ollama Documentation][1])
* comboは **編集不可**・クリックで即open（NoScrollComboBox統一） ([doc.qt.io][2])

### B-2) RAG側にも「更新」ボタン

* `🔄 モデル一覧再取得` を使用モデル設定ブロックの右上に置く
* 押下で

  * cloud_models.json 再読込 → cloudモデルコンボ更新
  * /api/tags 再取得 → 実行/品質/Embeddingコンボ更新
* 既存に “モデル一覧取得” があるなら、**そのボタンを上記の挙動に統合**する

---

## C) 反映の自動化（できれば：推奨）

ボタンだけでも解決しますが、「直したのに反映されない」を根絶するなら **signalで連動**が効果的です。

### C-1) cloudAI側

* cloud_models.json を保存（追加/削除/編集）したタイミングで
  `cloud_models_updated.emit()` を発火

### C-2) localAI側

* Ollamaモデル一覧（/api/tags）を更新したタイミングで
  `local_models_updated.emit()` を発火

### C-3) mixAI / RAG側

* そのsignalを受けたら `refresh_model_dropdowns()` を呼んで再構築

（※signalを入れるのが重いなら、今回要件どおり“更新ボタン”のみでもOK）

---

# 受け入れテスト（必須）

1. cloudAIで cloud_models.json にモデルを追加/削除
   → mixAI Phase1/3/2/3.5/4 と RAG cloudモデルの候補が **更新ボタン押下で全件反映**される
   （できればsignalでも自動反映）

2. localAIで Ollamaにモデルを追加（pull）or 削除
   → mixAI Phase2 と RAG（実行/品質/Embedding）の候補が **全件反映**される

3. すべてのコンボで

* キーボードで文字編集できない（editable=false）
* どこクリックしてもリストが開く（showPopup） ([doc.qt.io][3])

---

# ClaudeCodeへ渡す“実行用プロンプト”（コピペ）

```text
HelixAIStudio v11.0.0 の未修正点を修正してください（mixAI設定/RAG設定のモデル候補とコンボ挙動）。

要件：
1) mixAI>設定
- Phase1/3: cloudAI登録済みモデル（config/cloud_models.json）を全件表示
- Phase2: cloudAI登録済みモデル全件 + localAIインストール済みモデル全件（Ollama GET /api/tags）を全件表示
- Phase3.5/Phase4: cloudAI登録済みモデルを全件表示
- すべてのコンボは setEditable(False)、どこクリックでも showPopup() が開く（Phase1/3と同じ挙動）

2) RAG>設定（使用モデル設定）
- cloudモデル: cloud_models.json 全件をコンボ表示
- “実行LLM”→“実行モデル”へ名称変更
- “品質チェックLLM”→“品質チェックモデル”へ名称変更
- 実行モデル/品質チェックモデル/Embeddingモデル: Ollama /api/tags 全件をコンボ表示
- コンボは編集不可＋どこクリックでもドロップダウン表示

3) 反映ボタン
- mixAI設定とRAG設定に「🔄 モデル更新（再取得）」ボタンを配置し、
  cloud_models.json再読込 + Ollama /api/tags再取得 → 全ドロップダウン再構築を行う
- 可能なら cloudAI/localAI 側の更新イベント（signal）でも自動反映する（優先度はボタン＞signal）

実装指針：
- 固定の addItems([...]) を禁止し、CloudModelCatalog/LocalModelCatalog（単一情報源）から候補を生成する。
- QComboBox の editable は setEditable()、ドロップダウンは showPopup() を利用して統一する。
- Ollamaモデル一覧は GET /api/tags を使用する。

作業後：
- 変更箇所の diff を提示
- 上記受け入れテスト手順のチェック結果を簡潔に報告
```

---

必要なら、こちらで **あなたの実際のリポジトリ構造（cloud_models.jsonの読み込み関数名/場所）に合わせて**、`CloudModelCatalog` をどこに置くのが最小差分か（既存の `_load_cloud_models_to_combo()` の流用など）まで、ファイル単位で“ここをこう直す”に落とした版も作ります。

[1]: https://docs.ollama.com/api/tags?utm_source=chatgpt.com "List models - Ollama"
[2]: https://doc.qt.io/qtforpython-6.5/PySide6/QtWidgets/QComboBox.html?utm_source=chatgpt.com "QComboBox - Qt for Python"
[3]: https://doc.qt.io/qtforpython-6/PySide6/QtWidgets/QComboBox.html?utm_source=chatgpt.com "PySide6.QtWidgets.QComboBox - Qt for Python"


\## 提出物



\* exe："C:\Users\tomot\Desktop\開発環境\生成AIアプリ\Helix AI Studio\HelixAIStudio.exe"により起動可能な状態
\* BIBLE：`BIBLE\\BIBLE\_Helix AI Studio\_新バージョン.md`
\* 修正サマリー：差分と理由、受入条件の達成状況をテキストで提出
\* 



---



